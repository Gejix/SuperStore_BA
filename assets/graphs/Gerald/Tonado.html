<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

     <!-- Import the d3.js library and the CSS stylesheet -->
    <script src="https://d3js.org/d3.v7.min.js" charset="utf-8"></script>
    <link href="../../css/style.css" rel="stylesheet">
    <title>Revenue vs Profit</title>
</head>
<body>
    <!-- Create a paragraph element with the ID "example" -->
    <p id="example"></p>

    <!-- Define a function named tornadoChart -->
    <script>
    function tornadoChart() {
    const margin = { top: 70, right: 60, bottom: 50, left: 460 },
          width = 1000,
          height = 700,
          plot_width = width - margin.left - margin.right,
          plot_height = height - margin.top - margin.bottom, 
          padding = 7,
          adjustNegLabels = 6,
          adjustPosLabels = 2
          
          title= 'Tornado Chart'
          titleSize= 30;


    // Define scales for the x and y axes
    const x = d3.scaleLinear().range([margin.left, plot_width + margin.left]);
    const y = d3.scaleBand().range([margin.top, plot_height + margin.top]).padding(0.1);

    // Define axes for the chart
    const xAxis = d3.axisBottom(x).ticks(7);
    const yAxis = d3.axisLeft(y).tickSize(0);

    // Create a new SVG element with the defined width and height and add it to the HTML body
  const svg = d3
                .select("body")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .style('background', 'WhiteSmoke')
                .append("g")
                //.attr("transform", `translate(${margin.left}, ${margin.top})`);
                

    // Define a function named chart that creates a bar chart with the provided data
  function chart(selection) {
    
      selection.each(function (data) {
      // Set the domain for the x and y scales
      x.domain(d3.extent(data, function (d){return d.interactions}))//.nice();
      y.domain(data.map(function(d) { return d.product}));

      // Calculate the minimum interaction value
      const minInteractions = d3.min(data.map(function(d) {return d.interactions}));

      // Calculate the maximum interaction value
      const maxInteractions = d3.max(data.map(function(d) {return d.interactions}));      

      //console.log(Math.abs(x(minInteractions) - x(0)) + padding)

      // Set the tick padding of the y axis
      yAxis.tickPadding((x(0)- x(minInteractions)) + padding);
      //yAxis.tickPadding((x(0)- x(minInteractions) + margin.left) - padding);

      // Select all "rect" elements with class "bar" and bind the data to them
      const bar = svg.selectAll(".bar")
                     .data(data);

      // Add new "rect" elements for each data point and set their attributes
      const chart = bar.enter().append("rect")
                     .attr("class", function(d) {return `bar bar--${d.interactions < 0 ? "negative" : "positive"}`})
                     .attr("x", function(d) {return x(Math.min(0, d.interactions))})
                     .attr("y", function(d) {return y(d.product)})
                     .attr("width", function(d) {return Math.abs(x(d.interactions) - x(0))})
                     .attr("height", y.bandwidth());

      // Add new "text" elements for each data point and set their attributes
      const datalabels = bar.enter().append('text')
                          // Set text alignment to center.
                          .attr('class', function(d) {return `label label--${d.interactions < 0 ? "negative" : "positive"}`})
                          .attr("text-anchor", "middle")
                          .attr("text-anchor", function(d) {return `${d.interactions < 0 ? "end" : "start"}`})
                          // Position the text in the middle of the bar.
                          //.attr("x", (d) => x(Math.min(0, d.interactions)) + (Math.abs(x(d.interactions) - x(0)) / 2))
                          .attr('x', function(d) {return d.interactions < 0 ? x(0) - adjustNegLabels : x(d.interactions) + adjustPosLabels})
                          .attr("y", function(d) {return y(d.product) + (y.bandwidth() / 2)})
                          // Set vertical alignment to center.
                          .attr("dy", ".35em")
                          .text(function(d) {return d.interactions})
                          //.style();


      // Append the x-axis to the chart.
      svg.append("g")
        .attr("class", "xaxis")
        .attr("transform", `translate(0, ${plot_height + margin.top})`)
        .call(xAxis);

        // Append the y-axis to the chart.
      svg.append("g")
        .attr("class", "yaxis")
            // Translate the y-axis to the zero-interactions point.
        .attr("transform", `translate(${x(0)}, 0)`)
        .call(yAxis);

        //const hey = new Set(d3.map(data, function(d){return d.status}))
        //.console.log(hey)
                        

        //adding title to chart with svg text
        svg.append('text')
            .attr('y', margin.top - 20)
            .attr('x', width/2)
            .text(title)
            .attr('font-family', 'sans-serif')
            .attr('font-size', titleSize)
            .attr('text-anchor', 'middle');

        //adding Loss label to chart with svg text
        svg.append('text')
            .attr('y', margin.top)
            .attr('x', x(minInteractions/4))
            .text('Loss')
            .attr('font-family', 'sans-serif')
            .attr('font-size', 18)
            .attr('text-anchor', 'middle')
            .attr('font-weight', 'bold');

        //adding Profits label to chart with svg text
        svg.append('text')
            .attr('y', margin.top)
            .attr('x', x(maxInteractions/4))
            .text('Profits')
            .attr('font-family', 'sans-serif')
            .attr('font-size', 18)
            .attr('text-anchor', 'middle')
            .attr('font-weight', 'bold');        


    });
  }

  // Return the chart function.
  return chart;
}

// Define the data.
const data = {"Tonado1":[{"product":"Canon imageCLASS 2200 Advanced Copier","status":"profit","interactions":25000},
{"product":"Canon imageCLASS 2200 Advanced Copier","status":"revenue","interactions":-62000},
//{"product":"Fellowes PB500 Electric Punch Plastic Comb Binding Machine with Manual with Manual Bind","status":"male","interactions":8000},
//{"product":"Fellowes PB500 Electric Punch Plastic Comb Binding Machine with Manual with Manual Bind","status":"revenue","interactions":-27000},
{"product":"Fellowes PB500 Electric Punch Plastic Comb Binding Machine","status":"revenue","interactions":-27000},
{"product":"Fellowes PB500 Electric Punch Plastic Comb Binding Machine","status":"profit","interactions":8000},
{"product":"Hewlett Packard LaserJet 3310 Copier","status":"profit","interactions":7000},
{"product":"Hewlett Packard LaserJet 3310 Copier","status":"revenue","interactions":-19000},
{"product":"HP Designjet T520 Inkjet Large Format Printer - 24 Color","status":"profit","interactions":4000},
{"product":"HP Designjet T520 Inkjet Large Format Printer - 24 Color","status":"revenue","interactions":-18000},
{"product":"Ibico EPK-21 Electric Binding System","status":"profit","interactions":3000},
{"product":"Ibico EPK-21 Electric Binding System","status":"revenue","interactions":-16000},
{"product":"3D System Cube Printer, 2nd Generation, Magenta","status":"profit","interactions":4000},
{"product":"3D System Cube Printer, 2nd Generation, Magenta","status":"revenue","interactions":-14000},
{"product":"Logitech G19 Programmable Gaming Keyboard","status":"profit","interactions":4000},
{"product":"Logitech G19 Programmable Gaming Keyboard","status":"revenue","interactions":-14000},
{"product":"Canon PC1060 Personal Laser Copier","status":"profit","interactions":5000},
{"product":"Canon PC1060 Personal Laser Copier","status":"revenue","interactions":-12000},
{"product":"Ativa V4110MDD Micro-Cut Shredder","status":"profit","interactions":4000},
{"product":"Ativa V4110MDD Micro-Cut Shredder","status":"revenue","interactions":-8000},
{"product":"Zebra ZM400 Thermal Label Printer","status":"profit","interactions":3000},
{"product":"Zebra ZM400 Thermal Label Printer","status":"revenue","interactions":-7000}]};

// Loop through the data and draw the charts.
for (const i in data) {
  const chart = tornadoChart()
  d3.select("#example")
      .datum(data[i])
      .call(chart);
}

    </script>
</body>
</html>
