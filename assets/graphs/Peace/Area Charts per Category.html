<!DOCTYPE html>
<html lang = 'en'>
    <head>
        <title>Getting Started</title>
        <meta charset = "utf-8">
        <script src="https://d3js.org/d3.v7.min.js" charset = "utf-8"></script>
    </head>
    <body> 
        <!-- bgcolor= rgba(51, 170, 51, .1) -->
        <div style = 'background: rgba(51, 51, 180, 0.2)' ></div>
        <script>

        d3.json("Multiline Chart by Category.json").then(AreaChart); 
        
        function AreaChart(dataSet) {

            console.log("dataSet =", dataSet)

            const group_by = 'Category'

            const nested = Array.from(d3.group(dataSet, d => d[group_by]), ([key, value]) => ({key,value}))

            console.log(`Nested by ${group_by} =`, nested)  //dataset nested by group_by

            const months = d3.map(nested[0].value, function(d){ return d.Month});

            console.log('Months =', months ) //Months

            const category = d3.map(nested, function(d){ return d.key });  //
        
            console.log("Category = ", category)  //Category

            const data = d3.map(nested, function(d){ return d.value});

            console.log('Data =', data) // Array of 4 arrays of 12 dictionaries per month

            //Max Sales value
            const Sales_max = d3.max(dataSet.map(function(d){return (d["Sales"]);}))

            //Round up Maximum sales vlue to 2 significant figures
            //const yMax = Number(Sales_max.toPrecision(2))

            //Function to round up to 2 significant figures
            function round(num){
                
                let num_length = Math.ceil(num).toString().length
                power = '1'
                for(let i = 0; i < num_length - 2; i++){
                    power = power + '0'
                }
                return Math.ceil(num/power) * power

            }
            
            //const yMax = round(Sales_max)


            const yMax = 220000


            //Needed Dimensions
            const width = 1000;
            const height = 800;
            const paddingLeft = 50;
            const paddingBottom = 50;
            const lmargin = 50;
            const rmargin = 50;
            const tmargin = 50;
            const bmargin = 50;


            //Creating SVG Viewport for Graph
            const svg =
                d3.select('div')
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height)
                    .style('background', 'WhiteSmoke')
                    .style('border', '1px solid black');




            //SCALES

            //xscale
            const xScale =
                d3.scaleBand()         
                    .domain(months)                              
                    .range([paddingLeft, width - paddingLeft]); 

            
           
            //yscale
            const yScale =
                d3.scaleLinear()                      
                    .domain([0, yMax])
                    .range([height - paddingBottom, paddingBottom]);

            //group
            const graphGroup =
                svg.append('g')
                    .attr('id', 'graphGroup');



            //Color Scales
            const colourScale = d3.scaleOrdinal(d3.schemeCategory10);

            const colourScale2 = d3.scaleSequential()
                                    .domain(yScale.domain())
                                    .interpolator(d3.interpolate('blue', 'red')); 

                      

            
            //LINE GRAPH
            const areagraph = 
                graphGroup.selectAll('path.sales-data')                                    
                .data(data)
                .enter()
                    .append('path')
                    .attr('transform', `translate(${xScale.bandwidth() * 0.5}, ${0})`)      
                    .attr('class', 'sales-data')                                           
                    .attr('stroke', colourScale)
                    .attr('stroke-width', 3)
                    .attr('fill', colourScale) //
                    .style("opacity", 0.3)
                    .attr('d',
                        d3.area()                                                           
                            .x(function(d, i) {                                             
                                return xScale(d.Month)
                            })
                            .y0(height - bmargin)
                            .y1(function(d, i) {
                                return yScale(d['Sales'])
                            })
                            //.curve(d3.curveBasis)     //Making lines curved if necessary
                    );
              
            
            
           
                 
            //Axes for the graph

            //Choose a bottom axis type for our x-axis
            const xAxis = d3.axisBottom(xScale);

            //Choose a left axis type for our y-axis
            const yAxis = d3.axisLeft(yScale)               


            //Render the Axes in groups in the graphGroup
            //For Xaxis
            const xAxisGroup = graphGroup
                                    .append('g')
                                        .attr('transform', `translate(${0}, ${height - paddingBottom})`)
                                        .call(xAxis)

            //For Yaxis                           
            const yAxisGroup = graphGroup
                                    .append('g')
                                        .attr('id', 'y-axis')
                                        .attr('transform', `translate(${paddingLeft}, ${0})`)
                                        .call(yAxis)
                                            .selectAll('text')
                                            .attr('fill', colourScale2);   


            //Gridlines
            const verticalLines =
                            graphGroup
                                .append('g')
                                .attr('transform', `translate(${xScale.bandwidth() * 0.5}, ${0})`)      
                                .selectAll('line.grid-vertical-line')
                                .data(months)
                                .enter()
                                    .append('line')
                                        .attr('class', 'grid-vertical-line')
                                        .attr('x1', xScale)
                                        .attr('y1', yScale(0))
                                        .attr('x2', xScale)
                                        .attr('y2', yScale(yMax))
                                        .style('stroke', 'gray')
                                        .style('stroke-width', 1)
                                        .style('opacity', '0.25');                       

            
            
            const horizontalLines =
                            graphGroup
                                .append('g')
                                .attr('transform', `translate(${xScale.bandwidth() * 0.5}, ${0})`)       
                                .selectAll('line.grid-horizontal-line')
                                .data(yAxis.scale().ticks(12))
                                .enter()
                                    .append('line')
                                        .attr('class', 'grid-horizontal-line')
                                        .attr('x1', paddingLeft)
                                        .attr('y1', yScale)
                                        .attr('x2', width - paddingLeft - xScale.bandwidth())
                                        .attr('y2', yScale)
                                        .style('stroke', colourScale2)
                                        .style('stroke-width', 1)
                                        .style('opacity', '0.25')                
                                                  


            // ADDING SOME BASIC INTERACTION
            areagraph
            .on(
                'mouseenter',
                function(event) {
                    const thisPath = d3.select(this);
                    thisPath.style("opacity", 0.7);
                    thisPath.raise();
                }
            )
            .on(
                "mouseleave",
                function(event) {
                    const thisPath = d3.select(this);
                    thisPath.style("opacity", 0.3);
                }
            );
                                        

        }

    
        </script>
    </body>
</html>